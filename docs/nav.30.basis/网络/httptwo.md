---
title: http/2
time:  2019-10-16
author: wsm
mail: 1030057982@qq.com
---

**前身**
* SPDY 
	* SPDY 是 Google 开发的一个实验性协议，于 2009 年年中发布，其主要目标是通过解决 HTTP/1.1 中广为人知的一些性能限制来减少网页的加载延迟
	* SPDY 引入一个新的二进制分帧层，以实现请求和响应复用、优先级和标头压缩，目的是更有效地利用底层 TCP 连接

* HTTP 工作组 (HTTP-WG)  决定将 SPDY 规范作为新 HTTP/2 协议的基础

**THHP/2**
* 2进制分帧层
![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571191658866.png)


* 数据流、消息和帧
	* 数据流：已建立的连接内的双向字节流，可以承载一条或多条消息
	* 消息：与逻辑请求或响应消息对应的完整的一系列帧
	* 帧：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流

* 所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流
* 每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息
* 每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧
* 帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装

![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571191810990.png)


* HTTP/2 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。所有这些都在一个 TCP 连接内复用。 这是 HTTP/2 协议所有其他功能和性能优化的基础
	* 并行交错地发送多个请求，请求之间互不影响
	* 并行交错地发送多个响应，响应之间互不干扰
	* 使用一个连接并行发送多个请求和响应
	* 不必再为绕过 HTTP/1.x 限制而做很多工作（请参阅针对 HTTP/1.x 进行优化，例如级联文件、image sprites 和域名分片
	* 消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间
	* 等等…

* 数据流优先级
	*  HTTP 消息分解为很多独立的帧之后，我们就可以复用多个数据流中的帧，客户端和服务器交错发送和传输这些帧的顺序就成为关键的性能决定因素。 为了做到这一点，HTTP/2 标准允许每个数据流都有一个关联的权重和依赖关系
	*  服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端

* 每个来源一个连接
	* HTTP/2 既可以更有效地利用每个 TCP 连接，也可以显著降低整体协议开销。 不仅如此，使用更少的连接还可以减少占用的内存和处理空间，也可以缩短完整连接路径
	* 连接数量减少对提升 HTTPS 部署的性能来说是一项特别重要的功能：可以减少开销较大的 TLS 连接数、提升会话重用率，以及从整体上减少所需的客户端和服务器资源 

***
* 默认情况下，浏览器会针对这些情况使用同一个连接
    * 同一域名下的资源
    * 不同域名下的资源，但是满足两个条件：1）解析到同一个 IP；2）使用同一个证书
***

* 服务器推送
	* 对最初请求的响应外，服务器还可以向客户端推送额外资源（图 12-5），而无需客户端明确地请求
	
![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571193335664.png)

* 标头压缩
	* HTTP/2 使用 HPACK 压缩格式压缩请求和响应标头元数据
		* 这种格式支持通过静态霍夫曼代码对传输的标头字段进行编码，从而减小了各个传输的大小
		* 这种格式要求客户端和服务器同时维护和更新一个包含之前见过的标头字段的索引列表（换句话说，它可以建立一个共享的压缩上下文），此列表随后会用作参考，对之前传输的值进行有效编码

![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571193583327.png) 

****

**将网站升级至 http/2**
* nginx的最低版本是1.10.0
* openssl的最低版本是1.0.2

``` 
listen 443 ssl http2;
```
![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571193810703.png)


* nginx和客户端是HTTP/2，而nginx和业务服务还是HTTP/1.1，因为nginx的服务和业务服务通常是处于同一个内网，速度一般会很快，而nginx和客户端的连接就不太可控了，如果业务服务本身支持HTTP/2，会更好

* 浏览器支持
![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571193924437.png)

* 如果浏览器不支持http/2会怎么样呢？也是能够正常打开的，为什么呢？因为建立https连接的时候需要先握手，浏览器或者客户端会发送一个Client Hello的包，这个包里面会说明它是否支持http2

![enter description here](https://img.wsmpage.cn/learning/2019-10-16/1571193964057.png)



[推荐链接1](https://developers.google.com/web/fundamentals/performance/http2/)
[推荐链接2](https://zhuanlan.zhihu.com/p/29609078)